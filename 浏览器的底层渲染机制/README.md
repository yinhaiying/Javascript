## 浏览器的底层渲染机制

![](https://ftp.bmp.ovh/imgs/2021/03/f221ec38ed0a1ab7.png)
如上图所示：客户端输入网址，向百度发送请求，服务端返回的是一大串的html，然后浏览器将其解析展示成我们看到的页面了。那么到底是如何解析的了？也就是浏览器到底是如何渲染页面的，这就是我们今天学习的重点。



## 加载资源的同步异步
客户端从服务器获取到需要渲染的页面的源代码后，做了哪些事情？
**开辟一个GUI渲染线程，自上而下解析代码，最后绘制页面。**
![](https://ftp.bmp.ovh/imgs/2021/03/034a3d1eab5c5913.jpg)
如上图所示，GUI渲染线程自上而下进行解析，会碰到各种标签，比如style,link,script等，
这些自上而下渲染解析代码有些是同步的，但是有些操作也是异步的，比如：
 1. 遇到CSS资源的加载。
    * 遇到的是<style></style>内联样式。同步地交给GUI渲染线程解析
    * 遇到的是<link></link>外联样式。
       =>异步地进行处理，开辟一个新的http网络请求线程。(注意：同一个源下，根据不同的浏览器，最多只允许同时开辟4~7个HTTP线程，也就是“HTTP的并发数”)。
       =>不等待资源信息请求回来，GUI渲染线程继续往下渲染。
       =>GUI渲染线程同步操作完成后，再把基于Http网络线程请求回来的资源文件进行解析渲染。
    * 遇到@import "导入式样式"。
       => "同步"地开辟一个新的HTTP网络请求线程，去请求资源文件
       => 但是在资源文件没有请求回来之前，GUI渲染线程会被“阻塞”，不允许其继续向下渲染。
       => @import是阻碍GUI渲染线程渲染，因此，@import一般在项目中很少使用。

2. 遇到<script></script>资源的请求
   => 默认都是同步的：必须基于HTTP网络线程，把资源请求回来之后，并且交给“JS”渲染线程渲染解析完成后，GUI渲染线程才能继续向下渲染。
   => script默认也是阻碍GUI渲染机制向下渲染。
   => async属性实现异步渲染。遇到<script async></script>首先也是会开辟一个HTTP网络线程去请求加载资源文件，但是与此同时GUI渲染线程也会继续向下渲染。把默认的同步改成异步。但是一旦资源请求回来后，会中断GUI的渲染，会先将请求回来的资源文件进行解析渲染完成，才会继续后面的代码的解析渲染。
   => defer属性：遇到<script defer></script>首先也是会开辟一个HTTP网络线程去请求加载资源文件,但是与此同时GUI渲染线程也会继续向下渲染。但是`defer`是在GUI渲染完成之后，也就是同步代码执行完毕之后，才会渲染解析defer请求回来的资源。
3. 遇到<img><audio>等音视频资源。
   => 默认都是异步的，也会发送HTTP网络线程去请求加载对应的资源文件，不阻碍GUI的渲染，当GUI渲染完成之后，才会将请求回来的资源进行解析。

## 页面渲染的步骤：
1. DOM TREE(DOM树)：自上而下渲染完成页面，整理好整个页面的DOM结构关系，生成DOM树，如下图所示。(此时那些异步请求，比如Link样式的加载还等待解析执行)
![DOM树](https://ftp.bmp.ovh/imgs/2021/03/09771e428d17a649.png)
2. CSSOM TREE(css样式树)：当link等所有的样式资源请求回来后，按照引入CSS的顺序依次渲染CSS代码(因为后面的CSS会覆盖前面设置的CSS)，生成样式树，如下图所示。
![CSSOM树](https://ftp.bmp.ovh/imgs/2021/03/0b1fe694e9bfc1a7.jpg)
3. RENDER TREE(渲染树):等待样式树生成以后，会将DOM树和样式树合并在一起，形成渲染树（设置display:none的元素不会展示在渲染树中）。
![渲染树](https://ftp.bmp.ovh/imgs/2021/03/ba794f3ca7b49157.png)
4. Layout布局/回流/重排：根据生成的render树，计算他们在设备视口(viewport)内的确切位置和大小，这个计算的阶段就是回流=> 布局(layout)或者重排(reflow)。
5. 分层处理：按照层级定位分层处理，每一个层级都会详细规划出具体的绘制步骤。我们在编写CSS的时候，在定位时，经常会用到z-index，将页面内容分成不同的层级，因此浏览器渲染时也会进行分层处理，每一个层级给出具体的绘制步骤。
![分层处理](https://ftp.bmp.ovh/imgs/2021/03/a6bacc629b87d943.jpg)
6. Painting绘制：按照每一个层级给出的绘制步骤，进行页面的绘制。